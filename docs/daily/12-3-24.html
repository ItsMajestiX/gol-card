<!DOCTYPE html> <html lang="en"><head>
<title>12-3-24</title>
<base href="..">
<meta name="pathname" content="daily/12-3-24.html">
<meta name="description" content="gol_card_docs - 12-3-24">
<meta property="og:title" content="12-3-24">
<meta property="og:description" content="gol_card_docs - 12-3-24">
<meta property="og:type" content="website">
<meta property="og:url" content="daily/12-3-24.html">
<meta property="og:image" content="undefined">
<meta charset="UTF-8"><meta property="og:site_name" content="gol_card_docs"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0"><script async="" id="webpage-script" src="site-lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-wasm-script" src="site-lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="site-lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="site-lib/media/favicon.png"><link rel="stylesheet" href="site-lib/styles/obsidian.css"><link rel="preload" href="site-lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="site-lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/main-styles.css"></noscript><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-vertical-spacing:1.3em;--sidebar-margin:12px}:root{background-color:#202124}.sidebar{height:100%;font-size:14px;z-index:10;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));position:relative;overflow:hidden;overflow:clip;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}#left-sidebar{left:0}#right-sidebar{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}.sidebar.floating{position:absolute}.sidebar .leaf-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .leaf-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}#left-sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}#right-sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar #left-sidebar-content,.sidebar #right-sidebar-content{contain:none!important;container-type:normal!important;animation:none!important}.sidebar:has(.leaf-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:calc(2.3em + 2 * var(--sidebar-margin));width:var(--sidebar-width);padding:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}#left-sidebar .sidebar-topbar{left:0;flex-direction:row;border-top-right-radius:var(--radius-l)}#right-sidebar .sidebar-topbar{right:0;flex-direction:row-reverse;border-top-left-radius:var(--radius-l)}#left-sidebar .topbar-content{margin-right:calc(2.3em + var(--sidebar-margin));flex-direction:row}#right-sidebar .topbar-content{margin-left:calc(2.3em + var(--sidebar-margin));flex-direction:row-reverse}.topbar-content{overflow:hidden visible;overflow:clip visible;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:2px!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}#left-sidebar .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}#right-sidebar .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.feature-title{margin-left:1px;text-transform:uppercase;letter-spacing:.06em;margin-top:.75em;margin-bottom:.75em}.feature-header{display:flex;align-items:center;padding-top:0;font-size:1em;padding-left:0}body.floating-sidebars .sidebar{position:absolute}body{transition:background-color var(--color-fade-speed) ease-in-out}#navbar:not(:empty){display:flex;align-items:center;justify-content:space-between;padding:.5em 1em;width:100%}#main{display:flex;flex-direction:column;height:100%;width:100%;align-items:stretch;justify-content:center}#main-horizontal{display:flex;flex-direction:row;flex-grow:1;width:100%;align-items:stretch;justify-content:center}#center-content{flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0!important;transition:opacity .2s ease-in-out;pointer-events:none}#center-content>.obsidian-document{padding-left:2em;padding-right:1em;margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}body #center-content>.obsidian-document>.markdown-preview-sizer{padding-bottom:80vh;width:100%;max-width:var(--line-width);flex-basis:var(--line-width);transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}#center-content>.obsidian-document>div{width:100%!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}#center-content>.obsidian-document:not([data-type=markdown]).embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}#center-content>.obsidian-document:not([data-type=markdown]).embed>*{max-width:100%;max-height:100%;object-fit:contain}:not(h1,h2,h3,h4,h5,h6,li):has(> :is(.math,table)){overflow-x:auto!important}#center-content>.obsidian-document:not([data-type=markdown]){overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.obsidian-document[data-type=attachment]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;width:100%}.obsidian-document[data-type=attachment]>*{outline:0;border:none;box-shadow:none}.obsidian-document[data-type=attachment] :is(img){max-width:90%;max-height:90%;object-fit:contain}.obsidian-document[data-type=attachment]>:is(audio){width:100%;max-width:min(90%,var(--line-width))}.obsidian-document[data-type=attachment]>:is(embed,iframe,video){width:100%;height:100%;max-width:100%;max-height:100%;object-fit:contain}.canvas-wrapper>:is(.header,.footer){z-index:100;position:absolute;display:flex;justify-content:center;flex-direction:column;width:100%;align-items:center}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){let e=document.querySelectorAll("link[itemprop='include']");for(const t of e){let e=t.getAttribute("href");try{let o="";if(e.startsWith("https:")||e.startsWith("http:")||"file:"!=window.location.protocol){const n=await fetch(e);if(!n.ok){console.log("Could not include file: "+e),t?.remove();continue}o=await n.text()}else{const t=document.getElementById(btoa(encodeURI(e)));if(t){const e=JSON.parse(decodeURI(atob(t.getAttribute("value")??"")));o=e?.data??""}}let n=document.createRange().createContextualFragment(o);t.before(n),t.remove(),console.log("Included text: "+o),console.log("Included file: "+e)}catch(o){t?.remove(),console.log("Could not include file: "+e,o);continue}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script")));!function e(n){let l=o[n],c=n+1;l?(l&&"true"!=l.getAttribute("loaded")||n<o.length&&e(c),n<o.length&&l.addEventListener("load",(()=>e(c)))):n<o.length?e(c):t()}(0)}</script></head><body class="publish css-settings-manager styled-scrollbars show-inline-title show-ribbon is-focused"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="parsed-feature-container" style="display: contents;"><link itemprop="include" href="site-lib/html/custom-head-content-content.html"></div><div id="main"><div id="navbar"></div><div id="main-horizontal"><div id="left-content" class="leaf" style="--sidebar-width: var(--sidebar-width-left);"><div id="left-sidebar" class="sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><div id="search-container"><div id="search-wrapper"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div aria-label="Clear search" id="search-clear-button"></div></div></div></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content-wrapper"><div id="left-sidebar-content" class="leaf-content"><link itemprop="include" href="site-lib/html/file-tree-content.html"></div></div><script defer="">let ls = document.querySelector("#left-sidebar"); ls.classList.toggle("is-collapsed", window.innerWidth < 768); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div></div><div id="center-content" class="leaf"><div class="obsidian-document markdown-preview-view markdown-rendered node-insert-event is-readable-line-width allow-fold-headings allow-fold-lists show-indentation-guide show-properties" data-type="markdown"><style id="MJX-CHTML-styles">mjx-container[jax=CHTML]{line-height:0}mjx-container [space="1"]{margin-left:.111em}mjx-container [space="2"]{margin-left:.167em}mjx-container [space="3"]{margin-left:.222em}mjx-container [space="4"]{margin-left:.278em}mjx-container [space="5"]{margin-left:.333em}mjx-container [rspace="1"]{margin-right:.111em}mjx-container [rspace="2"]{margin-right:.167em}mjx-container [rspace="3"]{margin-right:.222em}mjx-container [rspace="4"]{margin-right:.278em}mjx-container [rspace="5"]{margin-right:.333em}mjx-container [size="s"]{font-size:70.7%}mjx-container [size=ss]{font-size:50%}mjx-container [size=Tn]{font-size:60%}mjx-container [size=sm]{font-size:85%}mjx-container [size=lg]{font-size:120%}mjx-container [size=Lg]{font-size:144%}mjx-container [size=LG]{font-size:173%}mjx-container [size=hg]{font-size:207%}mjx-container [size=HG]{font-size:249%}mjx-container [width=full]{width:100%}mjx-box{display:inline-block}mjx-block{display:block}mjx-itable{display:inline-table}mjx-row{display:table-row}mjx-row>*{display:table-cell}mjx-mtext{display:inline-block}mjx-mstyle{display:inline-block}mjx-merror{display:inline-block;color:red;background-color:#ff0}mjx-mphantom{visibility:hidden}mjx-assistive-mml{top:0;left:0;clip:rect(1px,1px,1px,1px);user-select:none;position:absolute!important;padding:1px 0 0!important;border:0!important;display:block!important;width:auto!important;overflow:hidden!important}mjx-assistive-mml[display=block]{width:100%!important}mjx-math{display:inline-block;text-align:left;line-height:0;text-indent:0;font-style:normal;font-weight:400;font-size:100%;letter-spacing:normal;border-collapse:collapse;overflow-wrap:normal;word-spacing:normal;white-space:nowrap;direction:ltr;padding:1px 0}mjx-container[jax=CHTML][display=true]{display:block;text-align:center;margin:1em 0}mjx-container[jax=CHTML][display=true][width=full]{display:flex}mjx-container[jax=CHTML][display=true] mjx-math{padding:0}mjx-container[jax=CHTML][justify=left]{text-align:left}mjx-container[jax=CHTML][justify=right]{text-align:right}mjx-mi{display:inline-block;text-align:left}mjx-c{display:inline-block}mjx-utext{display:inline-block;padding:.75em 0 .2em}mjx-mo{display:inline-block;text-align:left}mjx-stretchy-h{display:inline-table;width:100%}mjx-stretchy-h>*{display:table-cell;width:0}mjx-stretchy-h>*>mjx-c{display:inline-block;transform:scaleX(1)}mjx-stretchy-h>*>mjx-c::before{display:inline-block;width:initial}mjx-stretchy-h>mjx-ext{overflow:clip visible;width:100%}mjx-stretchy-h>mjx-ext>mjx-c::before{transform:scaleX(500)}mjx-stretchy-h>mjx-ext>mjx-c{width:0}mjx-stretchy-h>mjx-beg>mjx-c{margin-right:-.1em}mjx-stretchy-h>mjx-end>mjx-c{margin-left:-.1em}mjx-stretchy-v{display:inline-block}mjx-stretchy-v>*{display:block}mjx-stretchy-v>mjx-beg{height:0}mjx-stretchy-v>mjx-end>mjx-c{display:block}mjx-stretchy-v>*>mjx-c{transform:scaleY(1);transform-origin:left center;overflow:hidden}mjx-stretchy-v>mjx-ext{display:block;height:100%;box-sizing:border-box;border:0 solid transparent;overflow:visible clip}mjx-stretchy-v>mjx-ext>mjx-c::before{width:initial;box-sizing:border-box}mjx-stretchy-v>mjx-ext>mjx-c{transform:scaleY(500) translateY(.075em);overflow:visible}mjx-mark{display:inline-block;height:0}mjx-mn{display:inline-block;text-align:left}mjx-c::before{display:block;width:0}.MJX-TEX{font-family:MJXZERO,MJXTEX}.TEX-B{font-family:MJXZERO,MJXTEX-B}.TEX-I{font-family:MJXZERO,MJXTEX-I}.TEX-MI{font-family:MJXZERO,MJXTEX-MI}.TEX-BI{font-family:MJXZERO,MJXTEX-BI}.TEX-S1{font-family:MJXZERO,MJXTEX-S1}.TEX-S2{font-family:MJXZERO,MJXTEX-S2}.TEX-S3{font-family:MJXZERO,MJXTEX-S3}.TEX-S4{font-family:MJXZERO,MJXTEX-S4}.TEX-A{font-family:MJXZERO,MJXTEX-A}.TEX-C{font-family:MJXZERO,MJXTEX-C}.TEX-CB{font-family:MJXZERO,MJXTEX-CB}.TEX-FR{font-family:MJXZERO,MJXTEX-FR}.TEX-FRB{font-family:MJXZERO,MJXTEX-FRB}.TEX-SS{font-family:MJXZERO,MJXTEX-SS}.TEX-SSB{font-family:MJXZERO,MJXTEX-SSB}.TEX-SSI{font-family:MJXZERO,MJXTEX-SSI}.TEX-SC{font-family:MJXZERO,MJXTEX-SC}.TEX-T{font-family:MJXZERO,MJXTEX-T}.TEX-V{font-family:MJXZERO,MJXTEX-V}.TEX-VB{font-family:MJXZERO,MJXTEX-VB}mjx-stretchy-h mjx-c,mjx-stretchy-v mjx-c{font-family:MJXZERO,MJXTEX-S1,MJXTEX-S4,MJXTEX,MJXTEX-A!important}@font-face{font-family:MJXZERO;src:url("site-lib/fonts/mathjax_zero.woff") format("woff")}@font-face{font-family:MJXTEX;src:url("site-lib/fonts/mathjax_main-regular.woff") format("woff")}@font-face{font-family:MJXTEX-B;src:url("site-lib/fonts/mathjax_main-bold.woff") format("woff")}@font-face{font-family:MJXTEX-I;src:url("site-lib/fonts/mathjax_math-italic.woff") format("woff")}@font-face{font-family:MJXTEX-MI;src:url("site-lib/fonts/mathjax_main-italic.woff") format("woff")}@font-face{font-family:MJXTEX-BI;src:url("site-lib/fonts/mathjax_math-bolditalic.woff") format("woff")}@font-face{font-family:MJXTEX-S1;src:url("site-lib/fonts/mathjax_size1-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S2;src:url("site-lib/fonts/mathjax_size2-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S3;src:url("site-lib/fonts/mathjax_size3-regular.woff") format("woff")}@font-face{font-family:MJXTEX-S4;src:url("site-lib/fonts/mathjax_size4-regular.woff") format("woff")}@font-face{font-family:MJXTEX-A;src:url("site-lib/fonts/mathjax_ams-regular.woff") format("woff")}@font-face{font-family:MJXTEX-C;src:url("site-lib/fonts/mathjax_calligraphic-regular.woff") format("woff")}@font-face{font-family:MJXTEX-CB;src:url("site-lib/fonts/mathjax_calligraphic-bold.woff") format("woff")}@font-face{font-family:MJXTEX-FR;src:url("site-lib/fonts/mathjax_fraktur-regular.woff") format("woff")}@font-face{font-family:MJXTEX-FRB;src:url("site-lib/fonts/mathjax_fraktur-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SS;src:url("site-lib/fonts/mathjax_sansserif-regular.woff") format("woff")}@font-face{font-family:MJXTEX-SSB;src:url("site-lib/fonts/mathjax_sansserif-bold.woff") format("woff")}@font-face{font-family:MJXTEX-SSI;src:url("site-lib/fonts/mathjax_sansserif-italic.woff") format("woff")}@font-face{font-family:MJXTEX-SC;src:url("site-lib/fonts/mathjax_script-regular.woff") format("woff")}@font-face{font-family:MJXTEX-T;src:url("site-lib/fonts/mathjax_typewriter-regular.woff") format("woff")}@font-face{font-family:MJXTEX-V;src:url("site-lib/fonts/mathjax_vector-regular.woff") format("woff")}@font-face{font-family:MJXTEX-VB;src:url("site-lib/fonts/mathjax_vector-bold.woff") format("woff")}mjx-c.mjx-c1D45B.TEX-I::before{padding:.442em .6em .011em 0;content:"n"}mjx-c.mjx-c2212::before{padding:.583em .778em .082em 0;content:"−"}mjx-c.mjx-c31::before{padding:.666em .5em 0 0;content:"1"}mjx-c.mjx-c32::before{padding:.666em .5em 0 0;content:"2"}</style><div class="markdown-preview-sizer markdown-preview-section"><div class="header"><h1 class="page-title heading inline-title" id="12-3-24_0">12-3-24</h1><div class="data-bar"></div></div><div class="markdown-preview-pusher" style="width: 1px; height: 0.1px; margin-bottom: 0px;"></div><div class="el-p"><p dir="auto">On Sunday, I added in the 9-bit lookup table that I had mentioned previously, along with some unit tests. I assumed that the nine bit lookup would be faster, as it would have simpler shift logic and avoid a branch for each pixel to choose between two tables. However, this may not be the case.</p></div><div class="el-p"><p dir="auto">Starting from commit <code>ea0e51a3</code>, I replaced the contents of the <code>main()</code> function with the following:</p></div><div class="el-pre"><pre class="language-zig"><code data-line="0" class="language-zig is-loaded"><span class="token comment">// size of board and window</span>
<span class="token keyword">const</span> width <span class="token operator">=</span> <span class="token number">360</span><span class="token punctuation">;</span>
<span class="token keyword">comptime</span> <span class="token punctuation">{</span>
	std<span class="token punctuation">.</span>debug<span class="token punctuation">.</span><span class="token function">assert</span><span class="token punctuation">(</span>width <span class="token operator">%</span> <span class="token number">8</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// this makes copying rows much easier</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> height <span class="token operator">=</span> <span class="token number">240</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> board<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">(</span>width <span class="token operator">*</span> height <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin-type keyword">u8</span></span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> rng <span class="token operator">=</span> std<span class="token punctuation">.</span>rand<span class="token punctuation">.</span>DefaultPrng<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>std<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>random<span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token builtin-type keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rng<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>board<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> accum<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">u128</span></span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">..</span><span class="token number">10000</span><span class="token punctuation">)</span> <span class="token operator">|</span>_<span class="token operator">|</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> t0 <span class="token operator">=</span> std<span class="token punctuation">.</span>time<span class="token punctuation">.</span><span class="token function">nanoTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">updateBoard</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>board<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">const</span> t1 <span class="token operator">=</span> std<span class="token punctuation">.</span>time<span class="token punctuation">.</span><span class="token function">nanoTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	accum <span class="token operator">+=</span> <span class="token builtin">@intCast</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
std<span class="token punctuation">.</span>debug<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"10000 steps took {d}ns, avg {d:.3}ns\n"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">{</span> accum<span class="token punctuation">,</span> <span class="token builtin">@as</span><span class="token punctuation">(</span><span class="token builtin-type keyword">f64</span><span class="token punctuation">,</span> <span class="token builtin">@floatFromInt</span><span class="token punctuation">(</span>accum<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10000.0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">I then built and ran the code with <code>zig build -Doptimize=ReleaseFast run</code>, and got the following:</p></div><div class="el-pre"><pre><code data-line="0">10000 steps took 2522818969ns, avg 252281.897ns
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">I then stashed my changes and went back to commit <code>03b5bdb3</code> when the code had two tables and replaced main with the same code from before. After building using the same command, I got this:</p></div><div class="el-pre"><pre><code data-line="0">10000 steps took 1885709600ns, avg 188570.960ns
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">That is a speedup of about 25% compared to the slower speed! I ran the test on each version five times to get multiple trials</p></div><div class="el-p"><p dir="auto">Old:</p></div><div class="el-table" dir="ltr" style="overflow-x: auto;"><table>
<thead>
<tr>
<th dir="ltr">Run</th>
<th dir="ltr">Time to Complete 10000 Steps (ns)</th>
<th dir="ltr">Average Time Per Step (ns)</th>
</tr>
</thead>
<tbody>
<tr>
<td dir="auto">1</td>
<td dir="auto">1846089074</td>
<td dir="auto">184608.907</td>
</tr>
<tr>
<td dir="auto">2</td>
<td dir="auto">1865772319</td>
<td dir="auto">186577.232</td>
</tr>
<tr>
<td dir="auto">3</td>
<td dir="auto">1869270097</td>
<td dir="auto">186927.010</td>
</tr>
<tr>
<td dir="auto">4</td>
<td dir="auto">1863774093</td>
<td dir="auto">186377.409</td>
</tr>
<tr>
<td dir="auto">5</td>
<td dir="auto">1902552714</td>
<td dir="auto">190255.271</td>
</tr>
</tbody>
</table></div><div class="el-p"><p dir="auto">New:</p></div><div class="el-table" dir="ltr" style="overflow-x: auto;"><table>
<thead>
<tr>
<th dir="ltr">Run</th>
<th dir="ltr">Time to Complete 10000 Steps (ns)</th>
<th dir="ltr">Average Time Per Step (ns)</th>
</tr>
</thead>
<tbody>
<tr>
<td dir="auto">1</td>
<td dir="auto">2538883225</td>
<td dir="auto">253888.323</td>
</tr>
<tr>
<td dir="auto">2</td>
<td dir="auto">2555696677</td>
<td dir="auto">255569.668</td>
</tr>
<tr>
<td dir="auto">3</td>
<td dir="auto">2563169525</td>
<td dir="auto">256316.953</td>
</tr>
<tr>
<td dir="auto">4</td>
<td dir="auto">2563169525</td>
<td dir="auto">257624.299</td>
</tr>
<tr>
<td dir="auto">5</td>
<td dir="auto">2566034505</td>
<td dir="auto">256603.451</td>
</tr>
</tbody>
</table></div><div class="el-p"><p dir="auto">This isn't the most accurate test, as the kernel and background processes have an impact on this number. I did have a web browser with a few tabs and music in the background, but these were present (with maybe one tab of difference) in both sets of tests. However, it is clear that the old solution is much faster than the new one, even though I thought the new one would be an improvement. Why?</p></div><div class="el-p"><p dir="auto">My initial guess would be that the degraded performance has something to do with the use of <code>u9</code> in <code>shiftInRight()</code>. Here it is for reference:</p></div><div class="el-pre"><pre class="language-zig"><code data-line="0" class="language-zig is-loaded"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">shiftInRight</span><span class="token punctuation">(</span>lookup<span class="token punctuation">:</span> <span class="token class-name">u9</span><span class="token punctuation">,</span> row<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> top<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> bottom<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> col<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">)</span> <span class="token class-name">u9</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> newLookup <span class="token operator">=</span> lookup<span class="token punctuation">;</span>
	newLookup <span class="token operator">&lt;&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span>
	newLookup <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">bitmapGet</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> col<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	newLookup <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">bitmapGet</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	newLookup <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">bitmapGet</span><span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> col<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> newLookup<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">I don't know much about x86 assembly off of the top of my head, but there may be special instructions optimized for operating on smaller units of data instead of a full 64 bits. In addition, nine bits is not a standard bit width. LLVM may be adding in extra code to make it appear as though the value is truly nine bits. If this is the case, it may be solved by expanding to a standard 16 bits and one extra AND instruction to mask any bits higher than bit 9.</p></div><div class="el-p"><p dir="auto">To explore further, I went to <a data-tooltip-position="top" aria-label="https://godbolt.org/" rel="noopener nofollow" class="external-link is-unresolved" href="https://godbolt.org/" target="_self">Compiler Explorer</a> to dig into what LLM was producing for assembly for both sets of programs. I started off with the new version, using the following code:</p></div><div class="el-pre"><pre class="language-zig"><code data-line="0" class="language-zig is-loaded"><span class="token keyword">const</span> std <span class="token operator">=</span> <span class="token builtin">@import</span><span class="token punctuation">(</span><span class="token string">"std"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">bitmapGet</span><span class="token punctuation">(</span>bm<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> idx<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">)</span> <span class="token class-name"><span class="token builtin-type keyword">u8</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>bm<span class="token punctuation">[</span>idx <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token builtin">@truncate</span><span class="token punctuation">(</span>idx <span class="token operator">&amp;</span> <span class="token number">0x7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">shiftInRight</span><span class="token punctuation">(</span>lookup<span class="token punctuation">:</span> <span class="token class-name">u9</span><span class="token punctuation">,</span> row<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> top<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> bottom<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> col<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">)</span> <span class="token class-name">u9</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> newLookup <span class="token operator">=</span> lookup<span class="token punctuation">;</span>
    newLookup <span class="token operator">&lt;&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">bitmapGet</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> col<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">bitmapGet</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">bitmapGet</span><span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> col<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> newLookup<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token builtin-type keyword">anyerror</span><span class="token operator">!</span><span class="token builtin-type keyword">void</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> field<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin-type keyword">u8</span></span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> rng <span class="token operator">=</span> std<span class="token punctuation">.</span>rand<span class="token punctuation">.</span>DefaultPrng<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>std<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>random<span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token builtin-type keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rng<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> lookup <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span>u9<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lookup <span class="token operator">=</span> <span class="token function">shiftInRight</span><span class="token punctuation">(</span>lookup<span class="token punctuation">,</span> field<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">..</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> field<span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">..</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> field<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The usage of random is to prevent the compiler from optimizing away any operations by making the inputs to the function unpredictable. Here is the x86 assembly corresponding to the <code>shiftInRight</code> function in the new version:</p></div><div class="el-pre"><pre class="language-nasm"><code data-line="0" class="language-nasm is-loaded"><span class="token label function">example.shiftInRight:</span>
<span class="token label function">.Lfunc_begin34:</span>
        .loc    <span class="token number">51</span> <span class="token number">7</span> <span class="token number">0</span>
        .cfi_startproc
        push    <span class="token register variable">rbp</span>
        .cfi_def_cfa_offset <span class="token number">16</span>
        .cfi_offset <span class="token register variable">rbp</span>, <span class="token operator">-</span><span class="token number">16</span>
        mov     <span class="token register variable">rbp</span>, <span class="token register variable">rsp</span>
        .cfi_def_cfa_register <span class="token register variable">rbp</span>
        sub     <span class="token register variable">rsp</span>, <span class="token number">144</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">136</span><span class="token operator">]</span>, <span class="token register variable">rcx</span>
        mov     <span class="token register variable">rax</span>, <span class="token register variable">rdx</span>
        mov     <span class="token register variable">rdx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">136</span><span class="token operator">]</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">128</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
        mov     <span class="token register variable">eax</span>, <span class="token register variable">edi</span>
        mov     <span class="token register variable">rdi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">128</span><span class="token operator">]</span>
        mov     <span class="token register variable">r10w</span>, <span class="token register variable">ax</span>
        mov     <span class="token register variable">rax</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">+</span> <span class="token number">24</span><span class="token operator">]</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">120</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
        mov     <span class="token register variable">rcx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token operator">]</span>
        mov     <span class="token register variable">rax</span>, <span class="token register variable">rdi</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">112</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
        mov     <span class="token register variable">rax</span>, <span class="token register variable">rsi</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">104</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
        mov     <span class="token register variable">rax</span>, <span class="token register variable">r8</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">96</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
        mov     <span class="token register variable">rax</span>, <span class="token register variable">rdx</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">88</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
        mov     <span class="token register variable">rax</span>, <span class="token register variable">rcx</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">80</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
        mov     <span class="token register variable">rax</span>, <span class="token register variable">r9</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">72</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
<span class="token label function">.Ltmp563:</span>
        .loc    <span class="token number">51</span> <span class="token number">7</span> <span class="token number">102</span> prologue_end
        mov     <span class="token register variable">ax</span>, <span class="token register variable">r10w</span>
        and     <span class="token register variable">eax</span>, <span class="token number">511</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">58</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">48</span><span class="token operator">]</span>, <span class="token register variable">rdi</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">56</span><span class="token operator">]</span>, <span class="token register variable">rsi</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token operator">]</span>, <span class="token register variable">r8</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">40</span><span class="token operator">]</span>, <span class="token register variable">rdx</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">16</span><span class="token operator">]</span>, <span class="token register variable">rcx</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">24</span><span class="token operator">]</span>, <span class="token register variable">r9</span>
        .loc    <span class="token number">51</span> <span class="token number">8</span> <span class="token number">5</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">9</span> <span class="token number">5</span>
        mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">60</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        mov     <span class="token register variable">al</span>, <span class="token number">1</span>
<span class="token label function">.Ltmp564:</span>
        .loc    <span class="token number">51</span> <span class="token number">9</span> <span class="token number">5</span> is_stmt <span class="token number">0</span>
        test    <span class="token register variable">al</span>, <span class="token register variable">al</span>
        jne     .LBB34_2
        jmp     .LBB34_3
<span class="token label function">.Ltmp565:</span>
<span class="token label function">.LBB34_1:</span>
        .loc    <span class="token number">51</span> <span class="token number">0</span> <span class="token number">5</span>
        mov     <span class="token register variable">rdx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">120</span><span class="token operator">]</span>
        mov     <span class="token register variable">rsi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">96</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">88</span><span class="token operator">]</span>
        mov     <span class="token register variable">cx</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">60</span><span class="token operator">]</span>
        .loc    <span class="token number">51</span> <span class="token number">9</span> <span class="token number">5</span>
        mov     <span class="token register variable">ax</span>, <span class="token register variable">cx</span>
        and     <span class="token register variable">eax</span>, <span class="token number">63</span>
        shl     <span class="token register variable">eax</span>, <span class="token number">3</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">10</span> <span class="token number">5</span> is_stmt <span class="token number">1</span>
        mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">142</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">10</span> <span class="token number">28</span> is_stmt <span class="token number">0</span>
        call    example.bitmapGet
        mov     <span class="token register variable">cx</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">142</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">104</span><span class="token operator">]</span>
        mov     <span class="token register variable">rsi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">112</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">120</span><span class="token operator">]</span>
        .loc    <span class="token number">51</span> <span class="token number">10</span> <span class="token number">39</span>
        shl     <span class="token register variable">al</span>, <span class="token number">2</span>
        movzx   <span class="token register variable">eax</span>, <span class="token register variable">al</span>
        or      <span class="token register variable">cx</span>, <span class="token register variable">ax</span>
        mov     <span class="token register variable">ax</span>, <span class="token register variable">cx</span>
        and     <span class="token register variable">eax</span>, <span class="token number">511</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">11</span> <span class="token number">5</span> is_stmt <span class="token number">1</span>
        mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">140</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">11</span> <span class="token number">28</span> is_stmt <span class="token number">0</span>
        call    example.bitmapGet
        mov     <span class="token register variable">cx</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">140</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">72</span><span class="token operator">]</span>
        mov     <span class="token register variable">rsi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">80</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">120</span><span class="token operator">]</span>
        .loc    <span class="token number">51</span> <span class="token number">11</span> <span class="token number">39</span>
        add     <span class="token register variable">al</span>, <span class="token register variable">al</span>
        movzx   <span class="token register variable">eax</span>, <span class="token register variable">al</span>
        or      <span class="token register variable">cx</span>, <span class="token register variable">ax</span>
        mov     <span class="token register variable">ax</span>, <span class="token register variable">cx</span>
        and     <span class="token register variable">eax</span>, <span class="token number">511</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">12</span> <span class="token number">5</span> is_stmt <span class="token number">1</span>
        mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">138</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">12</span> <span class="token number">28</span> is_stmt <span class="token number">0</span>
        call    example.bitmapGet
        mov     <span class="token register variable">cx</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">138</span><span class="token operator">]</span>
        movzx   <span class="token register variable">eax</span>, <span class="token register variable">al</span>
        or      <span class="token register variable">cx</span>, <span class="token register variable">ax</span>
        mov     <span class="token register variable">ax</span>, <span class="token register variable">cx</span>
        and     <span class="token register variable">eax</span>, <span class="token number">511</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">13</span> <span class="token number">5</span> is_stmt <span class="token number">1</span>
        mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>
        .loc    <span class="token number">51</span> <span class="token number">13</span> <span class="token number">5</span> epilogue_begin is_stmt <span class="token number">0</span>
        add     <span class="token register variable">rsp</span>, <span class="token number">144</span>
        pop     <span class="token register variable">rbp</span>
        .cfi_def_cfa <span class="token register variable">rsp</span>, <span class="token number">8</span>
        ret
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">I then used this to check the assembly for the older version</p></div><div class="el-pre"><pre class="language-zig"><code data-line="0" class="language-zig is-loaded"><span class="token keyword">const</span> std <span class="token operator">=</span> <span class="token builtin">@import</span><span class="token punctuation">(</span><span class="token string">"std"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">bitmapGet</span><span class="token punctuation">(</span>bm<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> idx<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">)</span> <span class="token class-name"><span class="token builtin-type keyword">u8</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>bm<span class="token punctuation">[</span>idx <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token builtin">@truncate</span><span class="token punctuation">(</span>idx <span class="token operator">&amp;</span> <span class="token number">0x7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">shiftInRight</span><span class="token punctuation">(</span>lookup<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> row<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> top<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> bottom<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> col<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">)</span> <span class="token class-name"><span class="token builtin-type keyword">u8</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> newLookup <span class="token operator">=</span> lookup<span class="token punctuation">;</span>
    newLookup <span class="token operator">&lt;&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">=</span> std<span class="token punctuation">.</span>math<span class="token punctuation">.</span><span class="token function">rotl</span><span class="token punctuation">(</span><span class="token builtin-type keyword">u8</span><span class="token punctuation">,</span> newLookup<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">&amp;=</span> <span class="token number">0xF0</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">bitmapGet</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">bitmapGet</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">bitmapGet</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> col<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">bitmapGet</span><span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> col<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">=</span> std<span class="token punctuation">.</span>math<span class="token punctuation">.</span><span class="token function">rotl</span><span class="token punctuation">(</span><span class="token builtin-type keyword">u8</span><span class="token punctuation">,</span> newLookup<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> newLookup<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token builtin-type keyword">anyerror</span><span class="token operator">!</span><span class="token builtin-type keyword">void</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> field<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin-type keyword">u8</span></span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> rng <span class="token operator">=</span> std<span class="token punctuation">.</span>rand<span class="token punctuation">.</span>DefaultPrng<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>std<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>random<span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token builtin-type keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rng<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> lookup <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token builtin-type keyword">u8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lookup <span class="token operator">=</span> <span class="token function">shiftInRight</span><span class="token punctuation">(</span>lookup<span class="token punctuation">,</span> field<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">..</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> field<span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">..</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> field<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">This produced the following assembly:</p></div><div class="el-pre"><pre class="language-nasm"><code data-line="0" class="language-nasm is-loaded"><span class="token label function">example.shiftInRight:</span>
<span class="token label function">.Lfunc_begin34:</span>
        .loc    <span class="token number">51</span> <span class="token number">7</span> <span class="token number">0</span>
        .cfi_startproc
        push    <span class="token register variable">rbp</span>
        .cfi_def_cfa_offset <span class="token number">16</span>
        .cfi_offset <span class="token register variable">rbp</span>, <span class="token operator">-</span><span class="token number">16</span>
        mov     <span class="token register variable">rbp</span>, <span class="token register variable">rsp</span>
        .cfi_def_cfa_register <span class="token register variable">rbp</span>
        sub     <span class="token register variable">rsp</span>, <span class="token number">160</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">152</span><span class="token operator">]</span>, <span class="token register variable">rcx</span>
        mov     <span class="token register variable">rax</span>, <span class="token register variable">rdx</span>
        mov     <span class="token register variable">rdx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">152</span><span class="token operator">]</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">144</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
        mov     <span class="token register variable">eax</span>, <span class="token register variable">edi</span>
        mov     <span class="token register variable">rdi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">144</span><span class="token operator">]</span>
        mov     <span class="token register variable">rcx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">+</span> <span class="token number">24</span><span class="token operator">]</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">88</span><span class="token operator">]</span>, <span class="token register variable">rcx</span>
        mov     <span class="token register variable">rcx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token operator">]</span>
        mov     <span class="token register variable">r10</span>, <span class="token register variable">rdi</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">136</span><span class="token operator">]</span>, <span class="token register variable">r10</span>
        mov     <span class="token register variable">r10</span>, <span class="token register variable">rsi</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">128</span><span class="token operator">]</span>, <span class="token register variable">r10</span>
        mov     <span class="token register variable">r10</span>, <span class="token register variable">r8</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">120</span><span class="token operator">]</span>, <span class="token register variable">r10</span>
        mov     <span class="token register variable">r10</span>, <span class="token register variable">rdx</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">112</span><span class="token operator">]</span>, <span class="token register variable">r10</span>
        mov     <span class="token register variable">r10</span>, <span class="token register variable">rcx</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">104</span><span class="token operator">]</span>, <span class="token register variable">r10</span>
        mov     <span class="token register variable">r10</span>, <span class="token register variable">r9</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">96</span><span class="token operator">]</span>, <span class="token register variable">r10</span>
<span class="token label function">.Ltmp563:</span>
        .loc    <span class="token number">51</span> <span class="token number">7</span> <span class="token number">102</span> prologue_end
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">57</span><span class="token operator">]</span>, <span class="token register variable">al</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">48</span><span class="token operator">]</span>, <span class="token register variable">rdi</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">56</span><span class="token operator">]</span>, <span class="token register variable">rsi</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token operator">]</span>, <span class="token register variable">r8</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">40</span><span class="token operator">]</span>, <span class="token register variable">rdx</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">16</span><span class="token operator">]</span>, <span class="token register variable">rcx</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">24</span><span class="token operator">]</span>, <span class="token register variable">r9</span>
        .loc    <span class="token number">51</span> <span class="token number">8</span> <span class="token number">5</span>
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>, <span class="token register variable">al</span>
        .loc    <span class="token number">51</span> <span class="token number">9</span> <span class="token number">5</span>
        mov     <span class="token register variable">al</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>
        mov     <span class="token register variable">cl</span>, <span class="token number">3</span>
        shl     <span class="token register variable">al</span>, <span class="token register variable">cl</span>
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>, <span class="token register variable">al</span>
        .loc    <span class="token number">51</span> <span class="token number">10</span> <span class="token number">30</span>
        movzx   <span class="token register variable">edi</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>
        call    math.rotl__anon_7265
        mov     <span class="token register variable">cl</span>, <span class="token register variable">al</span>
        mov     <span class="token register variable">rax</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">88</span><span class="token operator">]</span>
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>, <span class="token register variable">cl</span>
        .loc    <span class="token number">51</span> <span class="token number">11</span> <span class="token number">5</span>
        mov     <span class="token register variable">cl</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>
        and     <span class="token register variable">cl</span>, <span class="token operator">-</span><span class="token number">16</span>
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>, <span class="token register variable">cl</span>
        .loc    <span class="token number">51</span> <span class="token number">12</span> <span class="token number">5</span>
        mov     <span class="token register variable">cl</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">73</span><span class="token operator">]</span>, <span class="token register variable">cl</span>
        .loc    <span class="token number">51</span> <span class="token number">12</span> <span class="token number">38</span> is_stmt <span class="token number">0</span>
        sub     <span class="token register variable">rax</span>, <span class="token number">2</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">72</span><span class="token operator">]</span>, <span class="token register variable">rax</span>
        setb    <span class="token register variable">al</span>
        jb      .LBB34_1
        jmp     .LBB34_2
<span class="token label function">.LBB34_1:</span>
        movabs  <span class="token register variable">rdi</span>, offset __anon_1620
        mov     <span class="token register variable">esi</span>, <span class="token number">16</span>
        xor     <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
        mov     <span class="token register variable">edx</span>, <span class="token register variable">eax</span>
        movabs  <span class="token register variable">rcx</span>, offset .L__unnamed_1
        call    example.panic
<span class="token label function">.LBB34_2:</span>
        .loc    <span class="token number">51</span> <span class="token number">0</span> <span class="token number">38</span>
        mov     <span class="token register variable">rsi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">136</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">128</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">72</span><span class="token operator">]</span>
        .loc    <span class="token number">51</span> <span class="token number">12</span> <span class="token number">28</span>
        call    example.bitmapGet
        mov     <span class="token register variable">rdi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">128</span><span class="token operator">]</span>
        mov     <span class="token register variable">rsi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">136</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">88</span><span class="token operator">]</span>
        mov     <span class="token register variable">cl</span>, <span class="token register variable">al</span>
        mov     <span class="token register variable">al</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">73</span><span class="token operator">]</span>
        .loc    <span class="token number">51</span> <span class="token number">12</span> <span class="token number">43</span>
        shl     <span class="token register variable">cl</span>, <span class="token number">3</span>
        or      <span class="token register variable">al</span>, <span class="token register variable">cl</span>
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>, <span class="token register variable">al</span>
        .loc    <span class="token number">51</span> <span class="token number">13</span> <span class="token number">5</span> is_stmt <span class="token number">1</span>
        mov     <span class="token register variable">al</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">155</span><span class="token operator">]</span>, <span class="token register variable">al</span>
        .loc    <span class="token number">51</span> <span class="token number">13</span> <span class="token number">28</span> is_stmt <span class="token number">0</span>
        call    example.bitmapGet
        mov     <span class="token register variable">rdi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">112</span><span class="token operator">]</span>
        mov     <span class="token register variable">rsi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">120</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">88</span><span class="token operator">]</span>
        mov     <span class="token register variable">cl</span>, <span class="token register variable">al</span>
        mov     <span class="token register variable">al</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">155</span><span class="token operator">]</span>
        .loc    <span class="token number">51</span> <span class="token number">13</span> <span class="token number">39</span>
        shl     <span class="token register variable">cl</span>, <span class="token number">2</span>
        or      <span class="token register variable">al</span>, <span class="token register variable">cl</span>
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>, <span class="token register variable">al</span>
        .loc    <span class="token number">51</span> <span class="token number">14</span> <span class="token number">5</span> is_stmt <span class="token number">1</span>
        mov     <span class="token register variable">al</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">154</span><span class="token operator">]</span>, <span class="token register variable">al</span>
        .loc    <span class="token number">51</span> <span class="token number">14</span> <span class="token number">28</span> is_stmt <span class="token number">0</span>
        call    example.bitmapGet
        mov     <span class="token register variable">rdi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">96</span><span class="token operator">]</span>
        mov     <span class="token register variable">rsi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">104</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">88</span><span class="token operator">]</span>
        mov     <span class="token register variable">r8b</span>, <span class="token register variable">al</span>
        mov     <span class="token register variable">al</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">154</span><span class="token operator">]</span>
        mov     <span class="token register variable">cl</span>, <span class="token number">1</span>
        .loc    <span class="token number">51</span> <span class="token number">14</span> <span class="token number">39</span>
        shl     <span class="token register variable">r8b</span>, <span class="token register variable">cl</span>
        mov     <span class="token register variable">cl</span>, <span class="token register variable">r8b</span>
        or      <span class="token register variable">al</span>, <span class="token register variable">cl</span>
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>, <span class="token register variable">al</span>
        .loc    <span class="token number">51</span> <span class="token number">15</span> <span class="token number">5</span> is_stmt <span class="token number">1</span>
        mov     <span class="token register variable">al</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">153</span><span class="token operator">]</span>, <span class="token register variable">al</span>
        .loc    <span class="token number">51</span> <span class="token number">15</span> <span class="token number">28</span> is_stmt <span class="token number">0</span>
        call    example.bitmapGet
        mov     <span class="token register variable">cl</span>, <span class="token register variable">al</span>
        mov     <span class="token register variable">al</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">153</span><span class="token operator">]</span>
        or      <span class="token register variable">al</span>, <span class="token register variable">cl</span>
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>, <span class="token register variable">al</span>
        .loc    <span class="token number">51</span> <span class="token number">16</span> <span class="token number">30</span> is_stmt <span class="token number">1</span>
        movzx   <span class="token register variable">edi</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>
        call    math.rotl__anon_7266
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>, <span class="token register variable">al</span>
        .loc    <span class="token number">51</span> <span class="token number">17</span> <span class="token number">5</span>
        mov     <span class="token register variable">al</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>
        .loc    <span class="token number">51</span> <span class="token number">17</span> <span class="token number">5</span> epilogue_begin is_stmt <span class="token number">0</span>
        add     <span class="token register variable">rsp</span>, <span class="token number">160</span>
        pop     <span class="token register variable">rbp</span>
        .cfi_def_cfa <span class="token register variable">rsp</span>, <span class="token number">8</span>
        ret
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The new version has 116 lines (including non instruction elements like labels), while the old version has 139. In addition, the old version makes calls to Zig's <code>std.math.rotl</code> and has more calls to <code>bitmapGet</code>. </p></div><div class="el-p"><p dir="auto">Compiler Explorer gives the ability to see the assembly corresponding to certain lines of code. I took a look at the assembly for the old version at the line corresponding to the left shift:</p></div><div class="el-pre"><pre class="language-nasm"><code data-line="0" class="language-nasm is-loaded">mov     <span class="token register variable">al</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>
mov     <span class="token register variable">cl</span>, <span class="token number">3</span>
shl     <span class="token register variable">al</span>, <span class="token register variable">cl</span>
mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>, <span class="token register variable">al</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Pretty simple. When I did the same for the new version, I found this block.</p></div><div class="el-pre"><pre class="language-nasm"><code data-line="0" class="language-nasm is-loaded">mov     <span class="token register variable">ax</span>, <span class="token register variable">cx</span>
and     <span class="token register variable">eax</span>, <span class="token number">63</span>
shl     <span class="token register variable">eax</span>, <span class="token number">3</span>
mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">This looks similar to the above. The problem is that this block is gated by a check of some sort, seen here. The check either leads to a panic handler, or to another jump that eventually leads to the assembly above. It's possible that such jumps could kill performance.</p></div><div class="el-p"><p dir="auto">I wanted to test out my 16bit idea, so I loaded the following code into Compiler Explorer:</p></div><div class="el-pre"><pre class="language-zig"><code data-line="0" class="language-zig is-loaded"><span class="token keyword">const</span> std <span class="token operator">=</span> <span class="token builtin">@import</span><span class="token punctuation">(</span><span class="token string">"std"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">bitmapGet</span><span class="token punctuation">(</span>bm<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> idx<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">)</span> <span class="token class-name"><span class="token builtin-type keyword">u8</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>bm<span class="token punctuation">[</span>idx <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">&gt;&gt;</span> <span class="token builtin">@truncate</span><span class="token punctuation">(</span>idx <span class="token operator">&amp;</span> <span class="token number">0x7</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">shiftInRight</span><span class="token punctuation">(</span>lookup<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">u16</span></span><span class="token punctuation">,</span> row<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> top<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> bottom<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">const</span> <span class="token builtin-type keyword">u8</span></span><span class="token punctuation">,</span> col<span class="token punctuation">:</span> <span class="token class-name"><span class="token builtin-type keyword">usize</span></span><span class="token punctuation">)</span> <span class="token class-name"><span class="token builtin-type keyword">u16</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> newLookup <span class="token operator">=</span> lookup<span class="token punctuation">;</span>
    newLookup <span class="token operator">&lt;&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">&amp;=</span> <span class="token number">0x1FF</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">bitmapGet</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> col<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">bitmapGet</span><span class="token punctuation">(</span>row<span class="token punctuation">,</span> col<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newLookup <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token function">bitmapGet</span><span class="token punctuation">(</span>bottom<span class="token punctuation">,</span> col<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> newLookup<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name"><span class="token builtin-type keyword">anyerror</span><span class="token operator">!</span><span class="token builtin-type keyword">void</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> field<span class="token punctuation">:</span> <span class="token class-name"><span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token builtin-type keyword">u8</span></span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> rng <span class="token operator">=</span> std<span class="token punctuation">.</span>rand<span class="token punctuation">.</span>DefaultPrng<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>std<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>random<span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token builtin-type keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rng<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> lookup <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token builtin-type keyword">u16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lookup <span class="token operator">=</span> <span class="token function">shiftInRight</span><span class="token punctuation">(</span>lookup<span class="token punctuation">,</span> field<span class="token punctuation">[</span><span class="token number">1</span><span class="token operator">..</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> field<span class="token punctuation">[</span><span class="token number">0</span><span class="token operator">..</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> field<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">..</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The added AND statement should make sure that the value would never exceed 9 set bits. Here is the assembly:</p></div><div class="el-pre"><pre class="language-nasm"><code data-line="0" class="language-nasm is-loaded"><span class="token label function">example.shiftInRight:</span>
<span class="token label function">.Lfunc_begin34:</span>
        .loc    <span class="token number">51</span> <span class="token number">7</span> <span class="token number">0</span>
        .cfi_startproc
        push    <span class="token register variable">rbp</span>
        .cfi_def_cfa_offset <span class="token number">16</span>
        .cfi_offset <span class="token register variable">rbp</span>, <span class="token operator">-</span><span class="token number">16</span>
        mov     <span class="token register variable">rbp</span>, <span class="token register variable">rsp</span>
        .cfi_def_cfa_register <span class="token register variable">rbp</span>
        sub     <span class="token register variable">rsp</span>, <span class="token number">128</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">128</span><span class="token operator">]</span>, <span class="token register variable">r8</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">120</span><span class="token operator">]</span>, <span class="token register variable">rcx</span>
        mov     <span class="token register variable">r10</span>, <span class="token register variable">rdx</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">104</span><span class="token operator">]</span>, <span class="token register variable">r10</span>
        mov     <span class="token register variable">r8</span>, <span class="token register variable">rsi</span>
        mov     <span class="token register variable">rsi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">128</span><span class="token operator">]</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">112</span><span class="token operator">]</span>, <span class="token register variable">r8</span>
        mov     <span class="token register variable">eax</span>, <span class="token register variable">edi</span>
        mov     <span class="token register variable">rdi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">120</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">+</span> <span class="token number">24</span><span class="token operator">]</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">72</span><span class="token operator">]</span>, <span class="token register variable">rdx</span>
        mov     <span class="token register variable">rcx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">+</span> <span class="token number">16</span><span class="token operator">]</span>
        mov     <span class="token register variable">r11</span>, <span class="token register variable">rcx</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">80</span><span class="token operator">]</span>, <span class="token register variable">r11</span>
        mov     <span class="token register variable">r11</span>, <span class="token register variable">r9</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">88</span><span class="token operator">]</span>, <span class="token register variable">r11</span>
<span class="token label function">.Ltmp563:</span>
        .loc    <span class="token number">51</span> <span class="token number">7</span> <span class="token number">104</span> prologue_end
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">58</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">48</span><span class="token operator">]</span>, <span class="token register variable">r10</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">56</span><span class="token operator">]</span>, <span class="token register variable">r8</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">32</span><span class="token operator">]</span>, <span class="token register variable">rsi</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">40</span><span class="token operator">]</span>, <span class="token register variable">rdi</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">16</span><span class="token operator">]</span>, <span class="token register variable">rcx</span>
        mov     qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">24</span><span class="token operator">]</span>, <span class="token register variable">r9</span>
        .loc    <span class="token number">51</span> <span class="token number">8</span> <span class="token number">5</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">9</span> <span class="token number">5</span>
        mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>
        shl     <span class="token register variable">ax</span>, <span class="token number">3</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">10</span> <span class="token number">5</span>
        mov     <span class="token register variable">al</span>, byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>
        and     <span class="token register variable">al</span>, <span class="token number">1</span>
        mov     byte ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">]</span>, <span class="token register variable">al</span>
        .loc    <span class="token number">51</span> <span class="token number">11</span> <span class="token number">5</span>
        mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">90</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">11</span> <span class="token number">28</span> is_stmt <span class="token number">0</span>
        call    example.bitmapGet
        mov     <span class="token register variable">rdi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">112</span><span class="token operator">]</span>
        mov     <span class="token register variable">rsi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">104</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">72</span><span class="token operator">]</span>
        mov     <span class="token register variable">cl</span>, <span class="token register variable">al</span>
        mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">90</span><span class="token operator">]</span>
        .loc    <span class="token number">51</span> <span class="token number">11</span> <span class="token number">39</span>
        shl     <span class="token register variable">cl</span>, <span class="token number">2</span>
        movzx   <span class="token register variable">ecx</span>, <span class="token register variable">cl</span>
        or      <span class="token register variable">ax</span>, <span class="token register variable">cx</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">12</span> <span class="token number">5</span> is_stmt <span class="token number">1</span>
        mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">62</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">12</span> <span class="token number">28</span> is_stmt <span class="token number">0</span>
        call    example.bitmapGet
        mov     <span class="token register variable">rdi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">88</span><span class="token operator">]</span>
        mov     <span class="token register variable">rsi</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">80</span><span class="token operator">]</span>
        mov     <span class="token register variable">rdx</span>, qword ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">72</span><span class="token operator">]</span>
        mov     <span class="token register variable">r8b</span>, <span class="token register variable">al</span>
        mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">62</span><span class="token operator">]</span>
        mov     <span class="token register variable">cl</span>, <span class="token number">1</span>
        .loc    <span class="token number">51</span> <span class="token number">12</span> <span class="token number">39</span>
        shl     <span class="token register variable">r8b</span>, <span class="token register variable">cl</span>
        mov     <span class="token register variable">cl</span>, <span class="token register variable">r8b</span>
        movzx   <span class="token register variable">ecx</span>, <span class="token register variable">cl</span>
        or      <span class="token register variable">ax</span>, <span class="token register variable">cx</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">13</span> <span class="token number">5</span> is_stmt <span class="token number">1</span>
        mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">60</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">13</span> <span class="token number">28</span> is_stmt <span class="token number">0</span>
        call    example.bitmapGet
        mov     <span class="token register variable">cl</span>, <span class="token register variable">al</span>
        mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">60</span><span class="token operator">]</span>
        movzx   <span class="token register variable">ecx</span>, <span class="token register variable">cl</span>
        or      <span class="token register variable">ax</span>, <span class="token register variable">cx</span>
        mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
        .loc    <span class="token number">51</span> <span class="token number">14</span> <span class="token number">5</span> is_stmt <span class="token number">1</span>
        mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>
        .loc    <span class="token number">51</span> <span class="token number">14</span> <span class="token number">5</span> epilogue_begin is_stmt <span class="token number">0</span>
        add     <span class="token register variable">rsp</span>, <span class="token number">128</span>
        pop     <span class="token register variable">rbp</span>
        .cfi_def_cfa <span class="token register variable">rsp</span>, <span class="token number">8</span>
        ret
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">This is only 94 lines, with only three calls to <code>bitmapGet</code>! In addition, the assembly corresponding to the left shift is only three instruction as opposed to four from before:</p></div><div class="el-pre"><pre class="language-nasm"><code data-line="0" class="language-nasm is-loaded">mov     <span class="token register variable">ax</span>, word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>
shl     <span class="token register variable">ax</span>, <span class="token number">3</span>
mov     word ptr <span class="token operator">[</span><span class="token register variable">rbp</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token operator">]</span>, <span class="token register variable">ax</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">There is also no branching beyond calling <code>bitmapGet</code>.</p></div><div class="el-p"><p dir="auto">This looked promising, so I went back and implemented these changes into the benchmark from earlier. The results?</p></div><div class="el-pre"><pre><code data-line="0">10000 steps took 1578029355ns, avg 157802.936ns
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">Let's run it more to be sure:</p></div><div class="el-table" dir="ltr" style="overflow-x: auto;"><table>
<thead>
<tr>
<th dir="ltr">Run</th>
<th dir="ltr">Time to Complete 10000 Steps (ns)</th>
<th dir="ltr">Average Time Per Step (ns)</th>
</tr>
</thead>
<tbody>
<tr>
<td dir="auto">1</td>
<td dir="auto">1603530326</td>
<td dir="auto">160353.033</td>
</tr>
<tr>
<td dir="auto">2</td>
<td dir="auto">1606371515</td>
<td dir="auto">160637.152</td>
</tr>
<tr>
<td dir="auto">3</td>
<td dir="auto">1605494190</td>
<td dir="auto">160549.419</td>
</tr>
<tr>
<td dir="auto">4</td>
<td dir="auto">1611504323</td>
<td dir="auto">161150.432</td>
</tr>
<tr>
<td dir="auto">5</td>
<td dir="auto">1604043195</td>
<td dir="auto">160404.320</td>
</tr>
</tbody>
</table></div><div class="el-p"><p dir="auto">Jackpot.</p></div><div class="el-p"><p dir="auto">The change from <code>u9</code>to <code>u16</code> saved 36% off of the best execution time of the <code>u9</code> code. The change to one table, along with the change to <code>u16</code>, saved 13% compared to the two table <code>u8</code> code. This experiment makes it clear that branching can really destroy your code's speed. I think I learned about the concept of branchless programming on youtube, and its been in the back of my mind. When I was writing the code for the simulator, I avoided having if statements in loops, moving code out of the loop in order to do so sometimes. In fact, there is only one if statement in the entire benchmark program, although it is in a loop.</p></div><div class="el-p"><p dir="auto">I'm going to merge the simulator in its current state back into <code>main</code> and start working on some of the other tasks. I should also write explaining more about the choice to use Zig as the programming language in this project.</p></div><div class="footer"><div class="data-bar"></div></div></div></div></div><div id="right-content" class="leaf" style="--sidebar-width: var(--sidebar-width-right);"><div id="right-sidebar" class="sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme-toggle-input" id=""><input class="theme-toggle-input" type="checkbox" id="theme-toggle-input"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content-wrapper"><div id="right-sidebar-content" class="leaf-content"><div class="graph-view-wrapper"><div class="feature-header"><div class="feature-title">Interactive Graph</div></div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<div class="graph-icon graph-global" role="button" aria-label="Global Graph" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-git-fork"><circle cx="12" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="6" r="3"></circle><path d="M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9"></path><path d="M12 12v3"></path></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div id="outline" class=" tree-container"><div class="feature-header"><div class="feature-title">Table Of Contents</div><button class="clickable-icon nav-action-button tree-collapse-all" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="daily/12-3-24.html#12-3-24_0" data-path="#12-3-24_0"><div class="tree-item-inner heading-link" heading-name="12-3-24">12-3-24</div></a><div class="tree-item-children"></div></div></div></div></div><script defer="">let rs = document.querySelector("#right-sidebar"); rs.classList.toggle("is-collapsed", window.innerWidth < 768); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></div></div></body></html>