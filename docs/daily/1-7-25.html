<!DOCTYPE html> <html lang="en"><head>
<title>1-7-25</title>
<base href="..">
<meta name="pathname" content="daily/1-7-25.html">
<meta name="description" content="gol_card_docs - 1-7-25">
<meta property="og:title" content="1-7-25">
<meta property="og:description" content="gol_card_docs - 1-7-25">
<meta property="og:type" content="website">
<meta property="og:url" content="daily/1-7-25.html">
<meta property="og:image" content="undefined">
<meta charset="UTF-8"><meta property="og:site_name" content="gol_card_docs"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0"><script async="" id="webpage-script" src="site-lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-wasm-script" src="site-lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="site-lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="site-lib/media/favicon.png"><link rel="stylesheet" href="site-lib/styles/obsidian.css"><link rel="preload" href="site-lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="site-lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="site-lib/styles/main-styles.css"></noscript><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-vertical-spacing:1.3em;--sidebar-margin:12px}:root{background-color:#202124}.sidebar{height:100%;font-size:14px;z-index:10;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));position:relative;overflow:hidden;overflow:clip;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}#left-sidebar{left:0}#right-sidebar{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}.sidebar.floating{position:absolute}.sidebar .leaf-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .leaf-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}#left-sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}#right-sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar #left-sidebar-content,.sidebar #right-sidebar-content{contain:none!important;container-type:normal!important;animation:none!important}.sidebar:has(.leaf-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:calc(2.3em + 2 * var(--sidebar-margin));width:var(--sidebar-width);padding:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}#left-sidebar .sidebar-topbar{left:0;flex-direction:row;border-top-right-radius:var(--radius-l)}#right-sidebar .sidebar-topbar{right:0;flex-direction:row-reverse;border-top-left-radius:var(--radius-l)}#left-sidebar .topbar-content{margin-right:calc(2.3em + var(--sidebar-margin));flex-direction:row}#right-sidebar .topbar-content{margin-left:calc(2.3em + var(--sidebar-margin));flex-direction:row-reverse}.topbar-content{overflow:hidden visible;overflow:clip visible;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:2px!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}#left-sidebar .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}#right-sidebar .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.feature-title{margin-left:1px;text-transform:uppercase;letter-spacing:.06em;margin-top:.75em;margin-bottom:.75em}.feature-header{display:flex;align-items:center;padding-top:0;font-size:1em;padding-left:0}body.floating-sidebars .sidebar{position:absolute}body{transition:background-color var(--color-fade-speed) ease-in-out}#navbar:not(:empty){display:flex;align-items:center;justify-content:space-between;padding:.5em 1em;width:100%}#main{display:flex;flex-direction:column;height:100%;width:100%;align-items:stretch;justify-content:center}#main-horizontal{display:flex;flex-direction:row;flex-grow:1;width:100%;align-items:stretch;justify-content:center}#center-content{flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0!important;transition:opacity .2s ease-in-out;pointer-events:none}#center-content>.obsidian-document{padding-left:2em;padding-right:1em;margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}body #center-content>.obsidian-document>.markdown-preview-sizer{padding-bottom:80vh;width:100%;max-width:var(--line-width);flex-basis:var(--line-width);transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}#center-content>.obsidian-document>div{width:100%!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}#center-content>.obsidian-document:not([data-type=markdown]).embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}#center-content>.obsidian-document:not([data-type=markdown]).embed>*{max-width:100%;max-height:100%;object-fit:contain}:not(h1,h2,h3,h4,h5,h6,li):has(> :is(.math,table)){overflow-x:auto!important}#center-content>.obsidian-document:not([data-type=markdown]){overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.obsidian-document[data-type=attachment]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;width:100%}.obsidian-document[data-type=attachment]>*{outline:0;border:none;box-shadow:none}.obsidian-document[data-type=attachment] :is(img){max-width:90%;max-height:90%;object-fit:contain}.obsidian-document[data-type=attachment]>:is(audio){width:100%;max-width:min(90%,var(--line-width))}.obsidian-document[data-type=attachment]>:is(embed,iframe,video){width:100%;height:100%;max-width:100%;max-height:100%;object-fit:contain}.canvas-wrapper>:is(.header,.footer){z-index:100;position:absolute;display:flex;justify-content:center;flex-direction:column;width:100%;align-items:center}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){let e=document.querySelectorAll("link[itemprop='include']");for(const t of e){let e=t.getAttribute("href");try{let o="";if(e.startsWith("https:")||e.startsWith("http:")||"file:"!=window.location.protocol){const n=await fetch(e);if(!n.ok){console.log("Could not include file: "+e),t?.remove();continue}o=await n.text()}else{const t=document.getElementById(btoa(encodeURI(e)));if(t){const e=JSON.parse(decodeURI(atob(t.getAttribute("value")??"")));o=e?.data??""}}let n=document.createRange().createContextualFragment(o);t.before(n),t.remove(),console.log("Included text: "+o),console.log("Included file: "+e)}catch(o){t?.remove(),console.log("Could not include file: "+e,o);continue}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script")));!function e(n){let l=o[n],c=n+1;l?(l&&"true"!=l.getAttribute("loaded")||n<o.length&&e(c),n<o.length&&l.addEventListener("load",(()=>e(c)))):n<o.length?e(c):t()}(0)}</script></head><body class="publish css-settings-manager styled-scrollbars show-inline-title show-ribbon is-focused"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="parsed-feature-container" style="display: contents;"><link itemprop="include" href="site-lib/html/custom-head-content-content.html"></div><div id="main"><div id="navbar"></div><div id="main-horizontal"><div id="left-content" class="leaf" style="--sidebar-width: var(--sidebar-width-left);"><div id="left-sidebar" class="sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><div id="search-container"><div id="search-wrapper"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div aria-label="Clear search" id="search-clear-button"></div></div></div></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content-wrapper"><div id="left-sidebar-content" class="leaf-content"><link itemprop="include" href="site-lib/html/file-tree-content.html"></div></div><script defer="">let ls = document.querySelector("#left-sidebar"); ls.classList.toggle("is-collapsed", window.innerWidth < 768); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div></div><div id="center-content" class="leaf"><div class="obsidian-document markdown-preview-view markdown-rendered node-insert-event is-readable-line-width allow-fold-headings allow-fold-lists show-indentation-guide show-properties" data-type="markdown"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><div class="header"><h1 class="page-title heading inline-title" id="1-7-25_0">1-7-25</h1><div class="data-bar"></div></div><div class="markdown-preview-pusher" style="width: 1px; height: 0.1px; margin-bottom: 0px;"></div><div class="el-p"><p dir="auto">Today I have reached a huge milestone in this project. Through manually uploading and dumping memory, I have gotten the MSP430FR2433 (the 16kB chip) to perform the same step computation as my desktop simulator, such that the MD5 hash of the two state files are the same.</p></div><div class="el-h1"><h1 data-heading="Build Toolchain" dir="auto" class="heading" id="Build_Toolchain_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Build Toolchain</h1></div><div class="el-p"><p dir="auto">When I left off <a data-tooltip-position="top" aria-label="12-30-24" data-href="12-30-24" href="daily/12-30-24.html" class="internal-link" target="_self" rel="noopener nofollow">last time</a>, I was going to work on the build toolchain side of things. I have now gotten the system to a point where, at least on Linux, the script should go from having no dependencies downloaded to having a <code>.elf</code> ready to flash. I need to have different logic at least for running the build tools on Windows, and possibly macOS too. I have not tested a complete run from no downloads to fully built, but I have tested the chain responsible for downloads and extraction and it works, at least on my machine.</p></div><div class="el-p"><p dir="auto">I ran into a challenge with the Call Frame Information (CFI) directives that LLVM outputs into the assembly again. TI's tools do not understand them and cause the assembler to error out. This is something that I ran into before while testing, but at the time I just deleted them manually. However, I had to make a way to do the same thing automatically. I created a custom step that takes in the <code>LazyPath</code> objects the build system uses and modifies the assembly file in place before it is copied to the output directory and put in the build chain. The step works fine, but does not play nice with Zig's cache system. If the step itself is not changed it works fine, but I ran into issues if I modified the step's code and didn't delete my cache. This would likely be solved by having different input and output files.</p></div><div class="el-p"><p dir="auto">Another feature of this build script is its ability to work with multiple MCUs without having to change the script itself. I set up a build option to switch between the 3 MCUs involved in this project. This option sets an enum value, which I then convert to a string and add directly into the arguments for GCC. To my knowledge, the argument mainly chooses the appropriate linker file.</p></div><div class="el-p"><p dir="auto">Speaking of linker files, adding them to the GCC include directory does not make them visible to GCC. I had to manually point GCC to the folder. Having to manually pass the folder enables me to make the custom ZIP file code that I modified from Zig's standard library simpler, but I have not done so yet. I also had to fall back to relying on <code>tar</code> to extract the files for Linux and macOS as TI compressed them using bzip2, which Zig does not have built in support for. Using the bzip2 library to do the decompression myself was an option, but not one that I wanted to spend time on.</p></div><div class="el-h1"><h1 data-heading="Getting Started With Launchpad" dir="auto" class="heading" id="Getting_Started_With_Launchpad_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Getting Started With Launchpad</h1></div><div class="el-p"><p dir="auto">Now that I had my build system set up, I dove into working with the two Launchpads I had ordered. I started off with the larger MSP430FR2476. I first tried to use the included ezfet driver to talk to the board. Between issues that I will discuss next, and the fact that the driver itself is known to be experimental, it did not work. I then switched to using the tilib driver. This required me to download the library <code>libmsp430.so</code> for MSPDebug to use, which TI provides on their website. I will need to incorporate this into the build system at some point. I may play around with trying to build the library from source, but it would be much easier to use TI's prebuilt version. After learning how to point MSPDebug to the file and that the 32 bit version of the library would not work on my machine, I was able to talk to the device. MSPDebug told me that my device needed an update, so I added the flag to let it do so.</p></div><div class="el-p"><p dir="auto">The update got to ~90% before freezing for a few seconds, and then "completed". Trying to reopen the connection gave an error. I was probably worried that I had already bricked the device, and tried replugging the board. Eventually I was able to rerun the update, but the same thing happened. After many tries and a different USB cable, I did get the update to go through. The USB cable was not the issue though, as I was still running into issues with getting my system to reliably connect to the board. At first I though the issue was the voltage being supplied to the chip, but that was not it. It turns out that to reliably connect that you need to let the board be powered on for a while before you connect. I have not done experiments to find the exact time, but 30-60 seconds is probably fine.</p></div><div class="el-p"><p dir="auto">After I had gotten the large board to work, I wanted to try the small MSP430FR2433 board too. Like the other board, it needed a firmware update to work. In my haste to get the new board to work however, I had already forgotten the need to let the board remain powered on for a time before connecting to it. I ran into the same partial upgrade issue as before, except that this time the driver wasn't able to autorecover it. At some point I switched over to my Windows install and used Code Composer Studio to recover the board, which also updated the board's firmware for me.</p></div><div class="el-p"><p dir="auto">Going back to the larger launchpad, I used MSPDebug to flash my code onto the board and tried running it in the debugger. However, it was never reaching an infinite loop that I had set up. I went on a debugging hunt to try and find out why. To make a long story short, I found out that my code was getting reset by a watchdog timer that is automatically started on reset and must be disabled manually. I ended up figuring this out by reading TI's manual for the chip, but not before spending a lot of time manually using the debugger to step through the code, which must affect this timer differently.</p></div><div class="el-h1"><h1 data-heading="Running Faster" dir="auto" class="heading" id="Running_Faster_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Running Faster</h1></div><div class="el-p"><p dir="auto">Once I had resolved my watchdog issue, I was able to get my code to run. However, I noticed it took ~20 seconds to go through the entire board. I mainly attributed this to the fact that the MCU defaults to running at 1MHz, and decided to get it to run at its maximum 16MHz. This took quite a bit of manual reading and googling to figure out, and I didn't get it right on the first try.</p></div><div class="el-p"><p dir="auto">The MSP430 MCUs that I use run their CPU off of a clock line called MCLK. MCLK can be sourced from a variety of inputs, but unless you want to run the CPU at &lt;50kHz you will need to source it from DCOCLKDIV. All of the chips that I am using have a digitally controlled oscilator (DCO) that is able to generate a much higher frequency clock signal from a lower frequency input, which in this case is 32768Hz clock. This frequency can either be internally generated by the chips reference oscillator (REFO) or an external crystal. Within each of the five DCO ranges on the chips that I'm using, the DCO can generate a wide range of frequencies. The specific frequency can be changed in software. However, the correct settings to achieve a certain frequency may change based on the chip's environment. With the use of the built in frequency locked loop (FLL), users do not need to worry about manually adjusting the DCO parameters themselves. All that you need to do is configure the output frequency you want as well as if you want to have the output frequency divided down from a higher frequency for more stability.</p></div><div class="el-p"><p dir="auto">Setting this up required doing a lot of hardware register manipulation. Zig actually has a feature called packed structs that makes tasks like this a lot easier. Packed structs let you reinterpret an integer as a series of fields that are allowed to have non-whole byte widths in a defined order.</p></div><div class="el-p"><p dir="auto">For example: here is the packed struct corresponding to how the register CSCTL2 is layed out:</p></div><div class="el-pre"><pre class="language-zig"><code data-line="0" class="language-zig is-loaded"><span class="token keyword">const</span> <span class="token class-name">ClockSystemControlRegister2</span> <span class="token operator">=</span> <span class="token keyword">packed</span> <span class="token keyword">struct</span><span class="token punctuation">(</span><span class="token builtin-type keyword">u16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment doc-comment">/// FLL Multiplier.</span>
    FLLN<span class="token punctuation">:</span> <span class="token class-name">u10</span><span class="token punctuation">,</span>
    _unused1<span class="token punctuation">:</span> <span class="token class-name">u2</span><span class="token punctuation">,</span>
    <span class="token comment doc-comment">/// FLL Divider.</span>
    FLLD<span class="token punctuation">:</span> <span class="token class-name">u3</span><span class="token punctuation">,</span>
    _unused2<span class="token punctuation">:</span> <span class="token class-name">u1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">I can then define a constant variable that points to one of these structures at the location of the register in memory:</p></div><div class="el-pre"><pre class="language-zig"><code data-line="0" class="language-zig is-loaded"><span class="token keyword">const</span> CSCTL2<span class="token punctuation">:</span> <span class="token class-name"><span class="token operator">*</span><span class="token keyword">volatile</span> ClockSystemControlRegister2</span> <span class="token operator">=</span> <span class="token builtin">@extern</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">volatile</span> ClockSystemControlRegister2<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"CSCTL2"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">The <code>volatile</code> keyword tells Zig that writes to this register may have side effects, and the use of <code>@extern</code> lets me reference the location of the register using the symbol list that TI provides in each chip's linker script. This way I do not have to hard code a selection between different addresses if they differ between the chips I use.<br>
<code>CSCTL2</code> can be used just like a normal struct from this point:</p></div><div class="el-pre"><pre class="language-zig"><code data-line="0" class="language-zig is-loaded">CSCTL2<span class="token punctuation">.</span>FLLN <span class="token operator">=</span> <span class="token number">487</span><span class="token punctuation">;</span> <span class="token comment">// 32768 Hz * (487 + 1) is about 16MHz</span>
CSCTL2<span class="token punctuation">.</span>FLLD <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Disable divider</span>
</code><button class="copy-code-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-copy"><rect x="8" y="8" width="14" height="14" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button></pre></div><div class="el-p"><p dir="auto">My first go at this kept resulting in the FLL maxing out the DCO and failing to stabilize. This is because I had the divider set to /2, which meant that the FLL was trying to achieve a frequency of 32MHz behind the scenes. Disabling the divider fixed the issue and I was able to run the step function in around a second. I also enabled FRAM wait states to prevent the MCU from resetting due to accessing FRAM too fast.</p></div><div class="el-h1"><h1 data-heading="Writing to the Board" dir="auto" class="heading" id="Writing_to_the_Board_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Writing to the Board</h1></div><div class="el-p"><p dir="auto">After I had done this, I added code to turn off and on FRAM write protection before and after the step function. By default, writing to FRAM will be silently ignored. This is likely to prevent a bit flip or an incorrect write from destroying program code since there is no special process for writing to FRAM, unlike flash memory. Since the board lives in FRAM, I need to be able to write to there during program execution. After this change, I used MSPDebug to dump the board from memory into a file that should be equivalent to the <code>state.bin</code> the desktop simulator uses to save its state. I got the MD5 hash of the state on both the MSP430 and on the desktop after being stepped once and saw that the board on the MSP430 had not updated at all. After checking the assembly code for the MSP430, I realized why. I had marked the board <code>const</code> in order for the compiler to put it into FRAM, assuming that casting to remove the constant attribute would make it behave like a <code>var</code>. However, Zig optimized out writes to the board. I had a problem: if I marked the board as <code>var</code> the linker would fail, but marking it as <code>const</code> doesn't work either.</p></div><div class="el-p"><p dir="auto">I knew that the solution lie in the <code>@export</code> builtin in Zig that allows you to customize how Zig exports symbols from your code. Marking board as <code>var</code> and telling zig to place it in .rodata did not work as the linker would complain about the redefinition of .rodata to be writable. I then tried to inject my own section definition with a <code>;</code> characted to comment out the incorrect output, but all of the special characters were escaped and it didn't work. After taking a look through the linker files, I found out that there is a special section called .persistent that seems to be just what I needed. After making the board <code>var</code> and telling Zig to place it there, I was able to get the match between the MSP430 and the desktop simulator that I had mentioned earlier.</p></div><div class="el-h1"><h1 data-heading="Next Steps" dir="auto" class="heading" id="Next_Steps_0"><span class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></span>Next Steps</h1></div><div class="el-p"><p dir="auto">Now that this is done, I'm going to merge <code>hal</code> back into main. It definitely grew way beyond just a HAL, so it's high time to make a new branch. The first feature I plan on implementing is a loop/step reset mechanism. After a certain number of steps, or if a loop of a certain size on the board is detected, the board will be refilled with random data. I plan to do this by taking the CRC of the board, as the MSP430 processors have a built in CRC module. I also need to work on getting random data on the MSP430. My plan right now is to use a floating digital pin to get a bit of entropy at each step, and then use that entropy combined with the board state to seed one of the default Zig RNGs. After this is done, I will start working on the eInk module driver.</p></div><div class="footer"><div class="data-bar"></div></div></div></div></div><div id="right-content" class="leaf" style="--sidebar-width: var(--sidebar-width-right);"><div id="right-sidebar" class="sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme-toggle-input" id=""><input class="theme-toggle-input" type="checkbox" id="theme-toggle-input"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content-wrapper"><div id="right-sidebar-content" class="leaf-content"><div class="graph-view-wrapper"><div class="feature-header"><div class="feature-title">Interactive Graph</div></div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<div class="graph-icon graph-global" role="button" aria-label="Global Graph" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-git-fork"><circle cx="12" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="6" r="3"></circle><path d="M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9"></path><path d="M12 12v3"></path></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div id="outline" class=" tree-container"><div class="feature-header"><div class="feature-title">Table Of Contents</div><button class="clickable-icon nav-action-button tree-collapse-all" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="daily/1-7-25.html#1-7-25_0" data-path="#1-7-25_0"><div class="tree-item-inner heading-link" heading-name="1-7-25">1-7-25</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="daily/1-7-25.html#Build_Toolchain_0" data-path="#Build_Toolchain_0"><div class="tree-item-inner heading-link" heading-name="Build Toolchain">Build Toolchain</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="daily/1-7-25.html#Getting_Started_With_Launchpad_0" data-path="#Getting_Started_With_Launchpad_0"><div class="tree-item-inner heading-link" heading-name="Getting Started With Launchpad">Getting Started With Launchpad</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="daily/1-7-25.html#Running_Faster_0" data-path="#Running_Faster_0"><div class="tree-item-inner heading-link" heading-name="Running Faster">Running Faster</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="daily/1-7-25.html#Writing_to_the_Board_0" data-path="#Writing_to_the_Board_0"><div class="tree-item-inner heading-link" heading-name="Writing to the Board">Writing to the Board</div></a><div class="tree-item-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-item-self is-clickable" href="daily/1-7-25.html#Next_Steps_0" data-path="#Next_Steps_0"><div class="tree-item-inner heading-link" heading-name="Next Steps">Next Steps</div></a><div class="tree-item-children"></div></div></div></div></div><script defer="">let rs = document.querySelector("#right-sidebar"); rs.classList.toggle("is-collapsed", window.innerWidth < 768); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></div></div></body></html>